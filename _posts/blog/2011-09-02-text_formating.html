---
layout: 01_post
title: "Text formating"
author: Herman Kraus
category: Mapnik
---

<p>Now that Google Summer of Code is over I'd like to show you some of theresults:</p><p>I already posted information about the <ahref="http://mapnik.org/news/2011/jul/13/new_text_placement_system/">newtext placement system</a>. No big changes happened here, just a fewbugfixes. I also added some <ahref="http://trac.mapnik.org/browser/branches/textplacement/tests/data/placement">testsand reference images</a>.</p><p>Improving text formating was the second half of my project.</p><p>Currently when you want to label a peak like this<div style="width:30%"><center><b>Name</b><br /><i>Elevation</i></center></div>you define these two symbolizers:<!--<pre>&lt;TextSymbolizer name="[name]" face-name="DejaVu Sans Bold"     size="12" placement="point" dy="3" wrap-width="35" /&gt;&lt;TextSymbolizer name="'('+[ele]+')'"    face-name="DejaVu Sans Oblique" size="9"    placement="point" dy="15" /&gt;</pre>--><script src="https://gist.github.com/1188916.js?file=gistfile1.xml"></script>The image will look like this:<br/><img src="/images/sample-old-short.png" alt="Sample image"/><br/>This usually works, but it has some limitations. For example let's see what happens when the name gets a little longer:<br/><img src="/images/sample-old-long.png" alt="Sample image"/><br/>Mapnik breaks the long name and the elevation disappears, because the offset is not correct. </p><p>Now let's have a look at how it is done with the new placement system:You only define one TextSymbolizer but with a different syntax:<!--<pre>&lt;TextSymbolizer face-name="DejaVu Sans Bold" size="12"   placement="point" dy="3" wrap-width="35" allow-overlap="0"&gt;    [name]+'&amp;#10;    '&lt;Format face-name="DejaVu Sans Oblique"       size="9"&gt;'('+[ele]+')'&lt;/Format&gt;&lt;/TextSymbolizer&gt;</pre>--><script src="https://gist.github.com/1188918.js?file=gistfile1.xml"></script>(Note: &amp;#10; is the XML encoding of a newline character)<br/><img src="/images/sample-new-short.png" alt="Sample image"/><img src="/images/sample-new-long.png" alt="Sample image"/><br/>As you can see Mapnik automatically takes care of correct line spacing, no need to calculate offsets manually. </p><h2>Backwards incompatible changes</h2><p>To make this work some backwards incompatibilities had to be introduced. </p><ul><li>Line spacing is no longer defined by the largest character in a certain text, but by the line spacing value defined in the font file. This should result in a nice line spacing by default, but if you have defined additional line spacing in your style you have to remove it or at least reduce it to get the same effect as before.</li><li>The text rendered by a TextSymbolizer is no longer given in the <emph>name</emph> attribute, but as a text node.<pre>&lt;TextSymbolizer name="[abc]" /&gt;</pre> becomes <pre>&lt;TextSymbolizer&gt;[abc]&lt;/TextSymbolizer&gt;</pre></li></ul><h2>Parameters you can change</h2><p>You can change the following text attributes with the <emph>Format</emph> instruction:</p><ul><li>face-name</li><li>size</li><li>character-spacing</li><li>line-spacing</li><li>opacity</li><li>wrap-character</li><li>text-transform</li><li>fill</li><li>halo-fill</li><li>halo-radius</li></ul><p>But you are not limited to using a fixed format. You can implement your own class in C++ to do the formating. It's very simple:<script src="https://gist.github.com/1188854.js?file=my_format.cpp"></script><!--<code><pre>class my_format: public abstract_formating_token{public:    void apply(char_properties &properties, Feature const& feature)    {        //Modify properties here    }};</pre></code>-->In the same way you can do custom text formating:<script src="https://gist.github.com/1188858.js?file=my_text.cpp"></script><!--<code><pre>class my_text : public abstract_text_token{public:    UnicodeString to_string(Feature const& feature)    {        return "some text here";    }};</pre>--></code></p><h2>Next steps</h2><p>The code is ready, now it's required to test it on larger styles to find any remaining bugs. Python bindings also have to be updated to fully support the new features. When this is done the code will be released as Mapnik 2.1 as it's to late in the release cycle to include it in Mapnik 2.0.<ul><li><a href="http://trac.mapnik.org/milestone/GSOC%20Text%20Placement">Bugs related to this work</a></li></ul></p>

