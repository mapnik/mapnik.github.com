---
layout: 01_post
title: "Future Mapnik"
author: Artem Pavlenko
category: Mapnik
---

<p>Recently I had chance to work on new features for Mapnik, thanks tosponsorship from Richard Weait. I'm so excited about these new features, I evennamed the new branch  <ahref="http://trac.mapnik.org/browser/branches/mapnik2"><strong>mapnik2</strong></a>.</p><h2>osm.xml</h2><p>Anyone familiar with the inner workings of <ahref="http://openstreetmap.org">OpenStreetMap</a>will know about the challenges of applying cartography to the wholeplanet - <a href="http://trac.openstreetmap.org/browser/applications/rendering/mapnik/osm.xml">osm.xml(mapnik stylesheet)</a> tells us a great deal about it (the size of thefile certainly does). So far Mapnik has handled anything thrown at it, andthe recent move to using XML entities in osm.xml (requires libxml2 parser) is a big steptowards making things a little bit more manageable. Still, the sheer numberof different Styles, Rules and Filters is overwhelming. Of course, XML is not for humanconsumption, but in reality this is how osm.xml isconstructed - by human hand and that file isn't getting any smaller...        </p><h2>Every road needs a shield</h2><p>There are lots of shields in Northern America. In fact, hundreds if notthousands of them. Richard Weait has written about it <ahref="http://weait.com/content/badges-badges">here</a>. Of course, it would be great to have customized/localized<a href="http://en.wikipedia.org/wiki/Numbered_highways_in_the_United_States">highwayshields</a> and this is just about possible,but it would require hundreds of lines XML. Fortunately, Richard Weaitalso had an answer - dynamic parameters.Sounds good, so how can we make it work? </p><h2>New expressions engine</h2><p>Welcome to the new expressions engine. It's based on <ahref="http://boost-spirit.com/home/spirit2/libs/spirit/doc/html/index.html">Boost.Spirit2.1</a> (the old one was spirit1 aka spirit classic). The existingfilter grammar was re-implemented to support expressions. In the past,filters would be evaluated at runtime to return boolean true/false(match/not match); now, the result of evaluation is a mapnik value - it canbe any of these : bool, int, double, UnicodeString.</p><p>This naturally begs the question: 'can we evaluate other things at run-time,too?'. And, sure, we can! Currently, the mapnik2 branch allows'filters', 'name' and 'file' attributes to be arbitary expressions. Well,'file' actually uses special type of expressions - 'path expression' (more aboutthis later on). And we are planning to add more support in the future. Expressions themselves canbe any valid combination of the following :<h3>Expressions</h3><table style="background:beige;border:1px solid grey;">  <tr><th colspan="2">Primary expressions</th></tr>  <tr><td>Boolean</td> <td>true, false </td></tr>  <tr><td>Integer</td> <td> 123 </td></tr>  <tr><td>Float</td> <td> 123.456 or -1.23e-04 </td></tr>  <tr><td>Unicode String</td><td>'unicode'</td></tr>  <tr><td>Attribute</td><td>[attribute name]</td></tr>  <tr><th colspan="2">Multiplicative expressions</th></tr>  <tr><td>Mult</td><td> 2 * 2</td></tr>  <tr><td>Div</td><td> 100 / 1.23e-4</td></tr>  <tr><td>Mod</td><td> 12 % 10</td></tr>  <tr><th colspan="2">Additive expressions</th></tr>  <tr><td>Plus</td> <td> 123 + 456</td></tr>  <tr><td>Minus</td> <td>123 - 456</td></tr>  <tr><th colspan="2">Relational expressions</th></tr>  <tr><td>Less than or equal to</td><td> <= , le </td></tr>  <tr><td>Less than</td><td> < , lt </td></tr>  <tr><td>Greater than or equal to</td><td> >= , ge </td></tr>  <tr><td>Greater than</td><td> > , gt </td></tr>  <tr><th colspan="2">Regular expressions</th></tr>  <tr><td>regex_match</td><td> (123 + 1).match('124') <br/> [name].match('^United.*')</td></tr>  <tr><th colspan="2">Equality</th></tr>  <tr><td>Equals</td><td> = , eq </td></tr>  <tr><td>Not equals</td><td> != , <>, neq </td></tr>  <tr><th colspan="2">Logic</th></tr>  <tr><td>Not</td><td> not , ! </td></tr>  <tr><td>And</td><td>and , && </td></tr>  <tr><td>Or</td><td>or , || </td></tr></table>I added perl-like alias operators to avoid escaping in XML.<pre>[val] ge 1000.00</pre>looks better then<pre>[val] &amp;gt; &amp;eq; 1000.0</pre><h3>Path expressions</h3>Path expressions grammar is very simple at the moment.You're allowed to use attributes as part of a file path e.g<pre>file="/opt/mapnik/osm/symbols/[highway]/[length].png"</pre>While this is not complicated it reduces the number of redundantentries in osm.xml by a factor! It also paves the way to themulti-shield world: if only we could know which country we're in:)OSM data is not very helpful here, maybe this will encourage adding newk:v's , we'll see. Enough talking, let's have an example.<p><h2>Flags of the world</h2><p>Let's imagine you want to create a map of the world, where each countryhas its own pattern based on that country's national flag. I knowthis is a bit far fetched, but nevertheless it shows the concept quiteclearly and the resulting map is fun. With current filter/rule logicyou'll have to create more than 250 rule objects, each with its ownfilter to catch individual countries - hmm.. nope. With the newexpressions approach we will get there with just one simple rule :<pre>&lt;PolygonPatternSymbolizer type="png" file="/opt/mapnik/mapnik-flags/flags/Flag_of_[cntry_name].png"/&gt;</pre>The [cntry_name] attribute is evaluated at run-time and we end up witha map like this one, great!: </p><a href="http://www.flickr.com/photos/40343925@N07/4166286290/" title="flags by mapnik, on Flickr"><img src="http://farm3.static.flickr.com/2721/4166286290_1d622dff02.jpg" width="500" height="341" alt="flags" /></a>

