---
layout: post
title: "MCS01 Roundup - Faster Mapnik"
author: Dane Springmeyer
---

<p>The first international <a href="http://trac.mapnik.org/wiki/MapnikCodeSprint/MCS01">Mapnik code sprint</a> wrapped up in London and San Francisco over the weekend. It was an amazing event, with new friendships made, new features discussed, and old bugs squashed.</p><p>I'm going to be reporting on various highlights as time permits and as I gather my thoughts. This first post details some performance improvements made to Mapnik on the first day of the sprint.</p><h2>Faster Mapnik</h2><p>Following the Mapnik project's first year of participation in the <a href="http://wiki.osgeo.org/wiki/Benchmarking_2010">FOSS4G WMS Shootout</a>, we learned that Mapnik is surprisingly fast, given that we've not yet done a lot of profiling and most focus of late has been on advanced cartography. We also learned that the new multi-threaded C++ <a href="http://trac.mapnik.org/wiki/Paleoserver">Paleoserver</a> Dane wrote for the shootout scales linearly.</p><h3>Room for improvement</h3><p>But there was one benchmark that Mapnik did very poorly in:  on-the-fly reprojection of shapefiles. Basically the test requires requests in Google Mercator and data to be pulled in EPSG:4326. This causes Mapnik, for each and every vertex of every geometry, to call out to proj.4 for transformation from source to destination srs. And because Proj.4 is not threadsafe in Mapnik this requires a threadlock for every single call to Proj.4. Because the <a href="http://trac.mapnik.org/wiki/Paleoserver"> Paleoserver model</a> is <em>one process, many threads</em>, this kind of locking has a <strong>much</strong> more adverse impact than for multiprocess servers.</p><p>But, we knew that the latest trunk of Proj.4 <a href="http://trac.osgeo.org/proj/wiki/ThreadSafety">has some new threadsafe support</a>. <a href="http://compton.nu/">Tom Hughes</a> took a closer look at this on the first afternoon of the sprint, and based on the new support for 'projCtx'  he enhanced Mapnik to avoid unecessary thread locking when built against Proj.4 version 4.8 (current trunk). The result is just what the team was hoping for and nothing short of awesome.</p><a href="http://media.mapnik.org/images/mcs01/wms_shapefile_reprojection_post_sprint.png"><img src="http://media.mapnik.org/images/mcs01/wms_shapefile_reprojection_post_sprint.png"  width="500" /></a><p>The above graph is a result of re-running the latest Mapnik (with the fix from <a href="http://trac.mapnik.org/ticket/605">#605</a>) on the official FOSS4G WMS benchmarking server. The blue line is MapServer's original result, and the chartreuse line is Mapnik's, while the green line shows how much faster Mapnik is after Tom's fix (both runs using <a href="http://trac.mapnik.org/wiki/Paleoserver">Paleoserver</a>). The green line also shows the Paleoserver throughput at 128 concurrent clients (higher load) which the original tests stopped short of (I plan to do more tests with even greater load to see if or where the Paleoserver stops being able to scale linearly).</p>

